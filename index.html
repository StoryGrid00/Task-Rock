<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Rock</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#9AE34A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Task Rock">
    <meta name="application-name" content="Task Rock">
    <meta name="msapplication-TileColor" content="#9AE34A">
    
    <!-- Icons for Browser Tabs and Mobile -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/browser-window-tab-thumbnail.png">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/browser-window-tab-thumbnail.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/browser-window-tab-thumbnail.png">
    <link rel="mask-icon" href="assets/images/browser-window-tab-thumbnail.png" color="#9AE34A">
    
    <!-- Favicon for older browsers -->
    <link rel="shortcut icon" href="assets/images/browser-window-tab-thumbnail.png">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Task Rock - A fun task management app with Jerry the Rock, your virtual pet companion">
    <meta name="keywords" content="task manager, productivity, pet rock, jerry, tasks, todo">
    <meta name="author" content="Task Rock">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Task Rock - Pet Rock Task Manager">
    <meta property="og:description" content="A fun task management app with Jerry the Rock, your virtual pet companion">
    <meta property="og:image" content="assets/images/icon-512x512.png">
    <meta property="og:url" content="https://storygrid00.github.io/Task_Rock">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Task Rock - Pet Rock Task Manager">
    <meta name="twitter:description" content="A fun task management app with Jerry the Rock, your virtual pet companion">
    <meta name="twitter:image" content="assets/images/icon-512x512.png">
    
    <style>
        :root {
    /* Daily Challenge complete color */
    --challenge-complete: #ccff00; /* neon green-yellow */

            /* Quick Task action button background token */
            --quick-action-bg: #ffffff;
            /* Daily Challenge (scoped) */
            --daily-card-purple: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --daily-card-green:  linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            --daily-card-orange-gradient: linear-gradient(135deg, #ea580c 0%, #f59e0b 100%);
        
            /* Light theme colors */
            --bg-primary: #f8f9fa;
            --bg-secondary: white;
            --bg-tertiary: #e0e0e0;
            --text-primary: #333;
            --text-secondary: #666;
            --text-tertiary: #999;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --modal-overlay: rgba(0, 0, 0, 0.5);
            --scrollbar-track: #f9fafb;
            --scrollbar-thumb: #d1d5db;
            --scrollbar-thumb-hover: #9ca3af;
            --health-bar-bg: #e0e0e0;
            --section-bg: white;
            --task-item-bg: white;
            --button-hover-bg: #f0f0f0;
            --congrats-bg: white;
            --achievement-locked-bg: #f5f5f5;
            --achievement-locked-text: #999;
            
            /* Modern additions */
            --accent-primary: #8FEB60;
            --accent-secondary: #7DD956;
            --accent-tertiary: #6BC748;
            --border-light: #e8eaed;
            --border-medium: #dadce0;
            --border-dark: #c4c7cc;
            --success: #34d399;
            --warning: #fbbf24;
            --error: #f87171;
            --info: #60a5fa;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;
            --transition-fast: 0.15s ease-out;
            --transition-normal: 0.25s ease-out;
            --transition-slow: 0.35s ease-out;
        }

        [data-theme="dark"] {
            --quick-action-bg: var(--bg-tertiary);
            /* Dark theme colors */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-tertiary: #999999;
            --border-color: #404040;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --scrollbar-track: #2d2d2d;
            --scrollbar-thumb: #555555;
            --scrollbar-thumb-hover: #777777;
            --health-bar-bg: #404040;
            --section-bg: #2d2d2d;
            --task-item-bg: #2d2d2d;
            --button-hover-bg: #404040;
            --congrats-bg: #2d2d2d;
            --achievement-locked-bg: #333333;
            --achievement-locked-text: #666666;
            --border-light: #374151;
            --border-medium: #4b5563;
            --border-dark: #6b7280;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Rounded', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 420px;
            margin: 0 auto;
            background: var(--bg-secondary);
            min-height: 100vh;
            position: relative;
            box-shadow: var(--shadow-xl);
        }

        /* Pet Rock Header with Theme Background */
        .pet-rock-header {
            background: var(--bg-secondary);
            padding: 24px 20px;
            text-align: center;
            position: relative;
            border-bottom: 1px solid var(--border-light);
        }

        
/* Scoped brand logo swap (no layout change) */
.app-title{ display:flex; align-items:center; justify-content:center; }
.brand-logo{ height:20px; width:auto; display:block; }
.brand-logo.dark{ display:none; }
@media (min-width: 640px){ .brand-logo{ height:24px; } }
[data-theme="dark"] .brand-logo.light{ display:none; }
[data-theme="dark"] .brand-logo.dark{ display:block; }

.app-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .creature-container {
            position: relative;
            margin: 16px 0;
        }

        .creature-image {
            width: 120px;
            height: 120px;
            margin: 0 auto 12px;
            display: block;
            border-radius: 50%;
            transition: transform var(--transition-normal);
        }

        .creature-image:hover {
            transform: scale(1.05);
        }

        .name-edit-wrap{width:100%; display:flex; align-items:center; justify-content:center; gap:8px;}
.creature-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            cursor: pointer;
            transition: color 0.2s ease;
            color: var(--text-primary);
         text-align:center; }
.edit-name-btn{background:transparent;border:none;padding:0;margin:0;cursor:pointer;font-size:16px;line-height:1;opacity:.8;transition:opacity var(--transition-fast);}
.edit-name-btn:hover{opacity:1;}


        .creature-name:hover {
            color: #007AFF;
        }

        .creature-name-input {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            border: none;
            background: transparent;
            text-align: center;
            outline: none;
            border-bottom: 2px solid #007AFF;
            font-family: 'SF Pro Rounded', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: var(--text-primary);
        }

        .health-bar-container {
            margin-bottom: 15px;
            width: 100%;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .health-bar {
            width: 100%;
            height: 20px;
            background: var(--health-bar-bg);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 5px;
            transition: background-color 0.3s ease;
        }

        .health-fill {
            height: 100%;
            background: #8FEB60;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .health-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .task-points {
            background: #007AFF;
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 400;
            display: inline-block;
        }

        /* Modern Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 20px;
            background: var(--bg-tertiary);
        }

        .expanded-stats {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
            padding: 0 20px;
        }

        .expanded-stats.show {
            display: grid;
        }

        .show-more-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
            padding: 8px 16px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            margin: 12px 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .show-more-btn:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all var(--transition-fast);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            font-size: 20px;
            margin-bottom: 8px;
            display: block;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Sections */
        .section {
            margin: 0;
            background: var(--section-bg);
            border-bottom: 1px solid var(--border-light);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .section-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color var(--transition-fast);
            user-select: none;
        }

        .section-header:hover {
            background: var(--section-bg);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-arrow {
            font-size: 16px;
            color: var(--text-secondary);
            transition: transform var(--transition-normal);
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-normal);
        }

        .section.expanded .section-content {
            max-height: 2000px;
        }

        .section-body {
            padding: 0 20px 20px;
        }

        /* Modern Task Cards */
        .task-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .task-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .task-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            position: relative;
        }

        .task-emoji {
            font-size: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .task-category {
            display: inline-block;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .task-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 500;
        }

        .task-badge.difficulty-easy { background: #dcfce7; color: #166534; }
        .task-badge.difficulty-medium { background: #fef3c7; color: #92400e; }
        .task-badge.difficulty-hard { background: #fee2e2; color: #991b1b; }

        .task-badge.priority-low { background: #f0f9ff; color: #0c4a6e; }
        .task-badge.priority-medium { background: #fef3c7; color: #92400e; }
        .task-badge.priority-high { background: #fee2e2; color: #991b1b; }

        /* 3-Dot Menu Styles */
        .task-menu-container {
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .task-menu-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            transition: background-color var(--transition-fast);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-menu-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .task-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            min-width: 120px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all var(--transition-fast);
        }

        .task-menu-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .task-menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color var(--transition-fast);
            color: var(--text-primary);
            font-size: 14px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .task-menu-item:hover {
            background: var(--bg-tertiary);
        }

        .task-menu-item:first-child {
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .task-menu-item:last-child {
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        .task-menu-item.delete:hover {
            background: var(--error);
            color: white;
        }

        .task-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            justify-content: flex-end;
        }

        .action-btn{
    width:36px; height:36px;
    display:flex; align-items:center; justify-content:center;
    background:#fff;
    border:2px solid var(--border-light);
    border-radius:10px;
    box-shadow: var(--shadow-sm);
    padding:0; line-height:1; cursor:pointer;
    }
    .action-btn:focus{ outline:2px solid var(--border-light); outline-offset:2px; }

        .action-btn:hover {
            background: var(--bg-tertiary);
        }

        .complete-btn {
            background: var(--accent-primary);
            color: #333;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .complete-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }

        /* Original Primary Button Style */
        .btn-primary {
            background: linear-gradient(135deg, #8FEB60 0%, #9AE34A 100%);
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, #7DD956 0%, #8FEB60 100%);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
            padding: 12px 24px;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-secondary:hover {
            background: var(--bg-quaternary);
            transform: translateY(-1px);
        }

        .create-task-btn {
            width: 100%;
            margin-top: 16px;
        }

        /* Daily Challenge Card - Purple Gradient Style */
        .daily-challenge-card {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: var(--radius-lg);
            padding: 20px;
            color: white;
            box-shadow: var(--shadow-md);
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .challenge-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
        }

        .challenge-desc {
            font-size: 14px;
            margin-bottom: 16px;
            opacity: 0.9;
            text-align: center;
        }

        .challenge-progress-container {
            margin-bottom: 12px;
        }

        .challenge-progress-label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
            opacity: 0.9;
        }

        .challenge-progress-bar {
            width: 100%;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .challenge-progress-fill {
            height: 100%;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            transition: width 0.3s ease;
            position: relative;
        }

        .challenge-reward {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 4px;
        }

        .challenge-completed {
            background: linear-gradient(135deg, var(--success) 0%, #22c55e 100%);
        }

        .challenge-completed .challenge-progress-fill {
            background: rgba(255, 255, 255, 0.6);
        }

        /* Quick Tasks */
        .quick-tasks-empty {
            text-align: center;
            padding: 32px 16px;
            color: var(--text-secondary);
        }

        .quick-tasks-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .quick-tasks-empty-text {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .quick-tasks-empty-subtext {
            font-size: 14px;
            opacity: 0.7;
        }

        .quick-task-item {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 8px 10px;
            margin-bottom: 8px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

/* Quick Tasks actions: scoped, icon-only, no containers */
.quick-task-item .quick-task-actions {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
}
.quick-task-item .action-btn{
    width:36px; height:36px;
    display:flex; align-items:center; justify-content:center;
    background: var(--quick-action-bg);
    border:2px solid var(--border-light);
    border-radius:10px;
    box-shadow: var(--shadow-sm);
    padding:0; line-height:1; cursor:pointer;
    }

/* Quick Task icons and states */
.action-complete{ border-color: var(--success); color: var(--success); }
.action-remove{ border-color: var(--error); color: var(--error); }
.icon-check, .icon-x{ font-size:18px; font-weight:800; line-height:1; }
.action-btn:hover{ filter: brightness(0.98); }

/* Dark mode: Quick Task action buttons use dark containers */
[data-theme="dark"] .quick-task-item .quick-task-actions .action-btn{
  background: var(--quick-action-bg) !important;
  background-color: var(--quick-action-bg) !important;
  border-color: var(--border-color) !important;
  box-shadow: var(--shadow-sm);
}


    .action-btn:focus{ outline:2px solid var(--border-light); outline-offset:2px; }
.quick-task-item .action-btn:hover,
.quick-task-item .action-btn:focus {
    background: var(--quick-action-bg); /* preserve existing hover pattern */
    outline: none;
}
.quick-task-item .action-btn.action-complete { color: var(--success); }
.quick-task-item .action-btn.action-remove   { color: var(--error); }


        .quick-task-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .quick-task-emoji {
            font-size: 18px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .quick-task-content {
            flex: 1;
            min-width: 0;
        }

        .quick-task-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .quick-task-category {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            display: inline-block;
        }

        .quick-task-points {
            background: var(--info);
            color: white;
            padding: 4px 8px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
        }

        /* Modal Modern Design */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--bg-secondary);
            margin: 5% auto;
            padding: 0;
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn var(--transition-normal);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(143, 235, 96, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Selection Grid */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .selection-item {
            padding: 12px;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--bg-secondary);
        }

        .selection-item:hover {
            background: var(--bg-tertiary);
        }

        .selection-item.selected {
            background: var(--accent-primary);
            border-color: var(--accent-secondary);
            color: #333;
        }

        .selection-item-emoji {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .selection-item-text {
            font-size: 12px;
            font-weight: 500;
        }

        /* Category Selection for Quick Tasks */
        .category-section {
            margin-bottom: 24px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        .category-emoji {
            font-size: 18px;
        }

        .category-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-tasks {
            display: grid;
            gap: 8px;
        }

        .category-task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid var(--border-light);
        }

        .category-task-item:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
        }

        /* Rock Shop Styles */
        .shop-grid {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
        }

        .shop-grid::-webkit-scrollbar {
            height: 6px;
        }

        .shop-grid::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 3px;
        }

        .shop-grid::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }

        .shop-grid::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        .shop-item {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all var(--transition-fast);
            cursor: pointer;
            min-width: 150px;
            flex-shrink: 0;
        }

        .shop-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .shop-item-image {
            width: 60px;
            height: 60px;
            margin: 0 auto 12px;
            display: block;
            border-radius: var(--radius-md);
        }

        .shop-item-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .shop-item-price {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .shop-item.affordable {
            border-color: var(--success);
        }

        .shop-item.expensive {
            opacity: 0.6;
        }

        /* Settings Styles */
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-label {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .settings-toggle {
            width: 50px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }

        .settings-toggle.active {
            background: var(--accent-primary);
        }

        .settings-toggle-slider {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        .settings-toggle.active .settings-toggle-slider {
            transform: translateX(22px);
        }

        /* Success Message */
        .success-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-full);
            font-weight: 600;
            z-index: 1001;
            animation: successSlideIn var(--transition-normal);
        }

        @keyframes successSlideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity var(--transition-normal);
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-brand{ width:240px; max-width:60%; margin-bottom:16px; display:block; }
.loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Achievement Styles */
        .achievement-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all var(--transition-fast);
        }

        .achievement-card.unlocked {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: #333;
        }

        .achievement-card.locked {
            background: var(--achievement-locked-bg);
            color: var(--achievement-locked-text);
        }

        .achievement-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .achievement-content {
            flex: 1;
        }

        .achievement-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .achievement-desc {
            font-size: 12px;
            opacity: 0.8;
        }

        .achievement-status {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
        }

        .achievement-status.unlocked {
            background: rgba(255, 255, 255, 0.2);
        }

        .achievement-status.locked {
            background: var(--bg-tertiary);
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
                box-shadow: none;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .expanded-stats {
                grid-template-columns: 1fr;
            }
            
            .selection-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
        }

        /* Dark mode specific adjustments */
        [data-theme="dark"] .task-badge.difficulty-easy { background: #166534; color: #dcfce7; }
        [data-theme="dark"] .task-badge.difficulty-medium { background: #92400e; color: #fef3c7; }
        [data-theme="dark"] .task-badge.difficulty-hard { background: #991b1b; color: #fee2e2; }
        [data-theme="dark"] .task-badge.priority-low { background: #0c4a6e; color: #f0f9ff; }
        [data-theme="dark"] .task-badge.priority-medium { background: #92400e; color: #fef3c7; }
        [data-theme="dark"] .task-badge.priority-high { background: #991b1b; color: #fee2e2; }
    

/* Daily Challenge rotating themes (scoped) */
.daily-challenge-card.theme-green { background: var(--daily-card-green) !important; }
.daily-challenge-card.theme-purple { background: var(--daily-card-purple) !important; }
.daily-challenge-card.theme-orange { background: var(--daily-card-orange-gradient) !important; }





.daily-challenge-card .progress-fill.completed{ 
    background: var(--challenge-complete) !important;
}
.jerry-dialogue-bubble {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 8px var(--shadow-color);
            max-width: 250px;
            text-align: center;
            font-weight: 500;
            color: var(--text-primary);
            animation: fadeInUp 0.3s ease;
            z-index: 100;
            margin-bottom: 5px;
            border: 2px solid #8FEB60;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }

        .jerry-dialogue-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: #8FEB60;
        }

        .jerry-dialogue-bubble::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--bg-secondary);
            z-index: 1;
            margin-top: -2px;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateX(-50%) translateY(10px); 
            }

/* Mobile: make success snackbar long and thin to match section width */
@media (max-width: 480px){
  .success-message{
    width: calc(100% - 32px);   /* match section horizontal padding/margin */
    max-width: 100%;
    padding: 8px 12px;
    top: 10px;
    border-radius: 14px;
    font-size: 14px;
    line-height: 1.25;
    text-align: center;
  }
}

</style>
</head>
<body>
    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas" style="position: fixed; inset: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999;"></canvas>
    
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
          <img class="loading-brand" src="assets/logo-light.png" alt="Task Rock" />
<div class="loading-spinner"></div>
        <div class="loading-text">Loading Task Rock...</div>
    </div>

    <div class="app-container">
        <!-- Pet Rock Header -->
        <div class="pet-rock-header">
            <h1 class="app-title">
  <img class="brand-logo light" src="assets/logo-light.png" alt="Task Rock logo (light)">
  <img class="brand-logo dark" src="assets/logo-dark.png" alt="Task Rock logo (dark)">
</h1>
            
            <div class="creature-container">
                <img id="creatureImage" src="assets/images/jerry-base.png" alt="Jerry the Rock" class="creature-image">
                <div class="name-edit-wrap" style="display:flex; align-items:center; gap:8px; justify-content:center; width:100%;"><div id="creatureName" class="creature-name" onclick="editCreatureName()">Jerry</div><button class="edit-name-btn" onclick="editCreatureName()" aria-label="Edit name" title="Edit name">✏️</button></div>
                <input type="text" id="creatureNameInput" class="creature-name-input" style="display: none;" onblur="saveCreatureName()" onkeypress="handleNameKeyPress(event)">
                
                <div class="health-bar-container">
                    <div class="health-bar">
                        <div id="healthFill" class="health-fill" style="width: 100%"></div>
                    </div>
                    <div id="healthText" class="health-text">Health: 100 - Level 1</div>
                </div>
                
                <div id="taskPoints" class="task-points">0 Points</div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">🚀</div>
                <div id="todaysTasksCount" class="stat-number">0</div>
                <div class="stat-label">Today's Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⏳</div>
                <div id="pendingTasksCount" class="stat-number">0</div>
                <div class="stat-label">Pending Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">✅</div>
                <div id="completedTasksCount" class="stat-number">0</div>
                <div class="stat-label">Completed Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📈</div>
                <div id="completionRateCount" class="stat-number">0%</div>
                <div class="stat-label">Completion Rate</div>
            </div>
        </div>

        <!-- Expanded Stats (Hidden by default) -->
        <div id="expandedStats" class="expanded-stats">
            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div id="totalTasksCount" class="stat-number">0</div>
                <div class="stat-label">Total Tasks</div>
            </div>
    
            <div class="stat-card">
                <div class="stat-icon">🔥</div>
                <div id="currentStreakCount" class="stat-number">0</div>
                <div class="stat-label">Current Streak</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🏆</div>
                <div id="bestStreakCount" class="stat-number">0</div>
                <div class="stat-label">Best Streak</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⭐</div>
                <div id="jerryLevelCount" class="stat-number">1</div>
                <div class="stat-label">Jerry Level</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🎯</div>
                <div id="experienceCount" class="stat-number">0/100</div>
                <div class="stat-label">Experience</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🏅</div>
                <div id="achievementsCount" class="stat-number">0/10</div>
                <div class="stat-label">Achievements</div>
            </div>
        </div>

        <!-- Show More Button -->
        <button id="showMoreBtn" class="show-more-btn" onclick="toggleExpandedStats()">
            <span id="showMoreText">Show More</span>
            <span id="showMoreArrow">▼</span>
        </button>

        <!-- Your Tasks Section -->
        <div id="tasksSection" class="section expanded">
            <div class="section-header" onclick="toggleSection('tasks')">
                <div class="section-title">
                    📝 Your Tasks
                </div>
                <div id="tasksArrow" class="section-arrow"></div>
            </div>
            <div class="section-content">
                <div class="section-body">
                    <div id="tasksList">
                        <!-- Tasks will be populated here -->
                    </div>
                    <button class="btn-primary create-task-btn" onclick="openCreateTaskModal()">
                        ➕ Create New Task
                    </button>
                </div>
            </div>
        </div>

        <!-- Daily Challenge Section -->
        <div id="dailyChallengeSection" class="section expanded">
            <div class="section-header" onclick="toggleSection('dailyChallenge')">
                <div class="section-title">
                    📅 Daily Challenge
                </div>
                <div id="dailyChallengeArrow" class="section-arrow"></div>
            </div>
            <div class="section-content">
                <div class="section-body">
                    <div id="dailyChallengeDisplay">
                        <!-- Daily challenge will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Tasks Section -->
        <div id="quickTasksSection" class="section expanded">
            <div class="section-header" onclick="toggleSection('quickTasks')">
                <div class="section-title">
                    ⚡ Quick Tasks
                </div>
                <div id="quickTasksArrow" class="section-arrow"></div>
            </div>
            <div class="section-content">
                <div class="section-body">
                    <div id="quickTasksList">
                        <!-- Quick tasks will be populated here -->
                    </div>
                    <button class="btn-primary create-task-btn" onclick="openQuickTaskModal()">
                        ⚡ Add Quick Task
                    </button>
                </div>
            </div>
        </div>

        <!-- Achievements Section -->
        <div id="achievementsSection" class="section">
            <div class="section-header" onclick="toggleSection('achievements')">
                <div class="section-title">
                    🏆 Achievements
                </div>
                <div id="achievementsArrow" class="section-arrow"></div>
            </div>
            <div class="section-content">
                <div class="section-body">
                    <div id="achievementsList">
                        <!-- Achievements will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Rock Shop Section -->
        <div id="shopSection" class="section">
            <div class="section-header" onclick="toggleSection('shop')">
                <div class="section-title">
                    🗿 Rock Shop
                </div>
                <div id="shopArrow" class="section-arrow"></div>
            </div>
            <div class="section-content">
                <div class="section-body">
                    <h3>🎩 Hats</h3>
                    <div id="hatsShop" class="shop-grid">
                        <!-- Hat items will be populated here -->
                    </div>
                    
                    <h3>👓 Accessories</h3>
                    <div id="itemsShop" class="shop-grid">
                        <!-- Accessory items will be populated here -->
                    </div>
                    
                    <h3>🎨 Paint Jobs</h3>
                    <div id="paintShop" class="shop-grid">
                        <!-- Paint items will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="section">
            <div class="section-header" onclick="toggleSection('settings')">
                <div class="section-title">
                    ⚙️ Settings
                </div>
                <div id="settingsArrow" class="section-arrow"></div>
            </div>
            <div class="section-content">
                <div class="section-body">
                    <div class="settings-item">
                        <div class="settings-label">Dark Mode</div>
                        <div id="darkModeToggle" class="settings-toggle" onclick="toggleDarkMode()">
                            <div class="settings-toggle-slider"></div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">Notifications</div>
                        <div id="notificationsToggle" class="settings-toggle" onclick="toggleNotifications()">
                            <div class="settings-toggle-slider"></div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">Share Etsy Store</div>
                        <button class="btn-secondary" onclick="shareEtsyStore()">Share</button>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">Reset Progress</div>
                        <button class="btn-secondary" onclick="showResetOptions()" style="background: var(--error); color: white;">Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Task</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="form-group">
                        <label class="form-label">Task Title</label>
                        <input type="text" id="taskTitle" class="form-input" placeholder="Enter task title" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <div class="selection-grid">
                            <div class="selection-item" onclick="selectCategory('work')" data-category="work">
                                <div class="selection-item-emoji">💼</div>
                                <div class="selection-item-text">Work</div>
                            </div>
                            <div class="selection-item" onclick="selectCategory('learning')" data-category="learning">
                                <div class="selection-item-emoji">🎓</div>
                                <div class="selection-item-text">Learning</div>
                            </div>
                            <div class="selection-item" onclick="selectCategory('home')" data-category="home">
                                <div class="selection-item-emoji">🏠</div>
                                <div class="selection-item-text">Home</div>
                            </div>
                            <div class="selection-item" onclick="selectCategory('finance')" data-category="finance">
                                <div class="selection-item-emoji">💰</div>
                                <div class="selection-item-text">Finance</div>
                            </div>
                            <div class="selection-item" onclick="selectCategory('goals')" data-category="goals">
                                <div class="selection-item-emoji">🎯</div>
                                <div class="selection-item-text">Goals</div>
                            </div>
                            <div class="selection-item" onclick="selectCategory('projects')" data-category="projects">
                                <div class="selection-item-emoji">🛠️</div>
                                <div class="selection-item-text">Projects</div>
                            </div>
                            <div class="selection-item" onclick="selectCategory('errands')" data-category="errands">
                                <div class="selection-item-emoji">🚗</div>
                                <div class="selection-item-text">Errands</div>
                            </div>
                            <div class="selection-item" onclick="selectCategory('digital')" data-category="digital">
                                <div class="selection-item-emoji">📱</div>
                                <div class="selection-item-text">Digital</div>
                            </div>
                            <div class="selection-item" onclick="selectCategory('creative')" data-category="creative">
                                <div class="selection-item-emoji">🎨</div>
                                <div class="selection-item-text">Creative</div>
                            </div>
                            <div class="selection-item" onclick="selectCategory('social')" data-category="social">
                                <div class="selection-item-emoji">🤝</div>
                                <div class="selection-item-text">Social</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Difficulty</label>
                        <div class="selection-grid">
                            <div class="selection-item" onclick="selectDifficulty('easy')" data-difficulty="easy">
                                <div class="selection-item-emoji">😊</div>
                                <div class="selection-item-text">Easy (2 pts)</div>
                            </div>
                            <div class="selection-item" onclick="selectDifficulty('medium')" data-difficulty="medium">
                                <div class="selection-item-emoji">😐</div>
                                <div class="selection-item-text">Medium (5 pts)</div>
                            </div>
                            <div class="selection-item" onclick="selectDifficulty('hard')" data-difficulty="hard">
                                <div class="selection-item-emoji">😤</div>
                                <div class="selection-item-text">Hard (10 pts)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <div class="selection-grid">
                            <div class="selection-item" onclick="selectPriority('low')" data-priority="low">
                                <div class="selection-item-emoji">🟢</div>
                                <div class="selection-item-text">Low Priority</div>
                            </div>
                            <div class="selection-item" onclick="selectPriority('medium')" data-priority="medium">
                                <div class="selection-item-emoji">🟡</div>
                                <div class="selection-item-text">Medium Priority</div>
                            </div>
                            <div class="selection-item" onclick="selectPriority('high')" data-priority="high">
                                <div class="selection-item-emoji">🔴</div>
                                <div class="selection-item-text">High Priority</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Due Date (Optional)</label>
                        <input type="datetime-local" id="taskDueDate" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">🔁 Recurring Task</label>
                        <div class="selection-grid">
                            <div class="selection-item" onclick="selectRecurring('none')" data-recurring="none">
                                <div class="selection-item-emoji">📝</div>
                                <div class="selection-item-text">One-time</div>
                            </div>
                            <div class="selection-item" onclick="selectRecurring('daily')" data-recurring="daily">
                                <div class="selection-item-emoji">📅</div>
                                <div class="selection-item-text">Daily</div>
                            </div>
                            <div class="selection-item" onclick="selectRecurring('weekly')" data-recurring="weekly">
                                <div class="selection-item-emoji">📆</div>
                                <div class="selection-item-text">Weekly</div>
                            </div>
                            <div class="selection-item" onclick="selectRecurring('monthly')" data-recurring="monthly">
                                <div class="selection-item-emoji">🗓️</div>
                                <div class="selection-item-text">Monthly</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description (Optional)</label>
                        <textarea id="taskDescription" class="form-input form-textarea" placeholder="Enter task description"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="createTask()">Create Task</button>
            </div>
        </div>
    </div>

    <!-- Quick Task Selection Modal -->
    <div id="quickTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Quick Task</h2>
                <button class="modal-close" onclick="closeQuickTaskModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="quickTaskCategories">
                    <!-- Quick task categories will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            rockName: 'Jerry',
            health: 100,
            taskPoints: 0,
            tasks: [],
            completedTasks: 0,
            totalTasks: 0,
            currentStreak: 0,
            bestStreak: 0,
            lastCompletionDate: null,
            jerryLevel: 1,
            jerryXP: 0,
            jerryXPToNext: 100,
            dailyChallenge: null,
            dailyChallengeCompleted: false,
            lastDailyChallengeDate: null,
            lastQuickTasksDate: null,
            selectedQuickTasks: [],
            darkMode: false,
            notifications: false,
            ownedItems: [],
            currentOutfit: {
                hat: null,
                glasses: null,
                mustache: null,
                paint: null
            }
        };

        // Task creation variables
        let selectedCategory = null;
        let selectedDifficulty = null;
        let selectedPriority = null;
        let selectedRecurring = 'none';
        let editingTaskIndex = null;

        // Category mapping
        const categoryMap = {
            'work': { name: 'Work & Career', emoji: '💼' },
            'learning': { name: 'Learning & Education', emoji: '🎓' },
            'home': { name: 'Home & Family', emoji: '🏠' },
            'finance': { name: 'Finance & Planning', emoji: '💰' },
            'goals': { name: 'Personal Goals', emoji: '🎯' },
            'projects': { name: 'Projects & Hobbies', emoji: '🛠️' },
            'errands': { name: 'Errands & Appointments', emoji: '🚗' },
            'digital': { name: 'Digital & Technology', emoji: '📱' },
            'creative': { name: 'Creative & Arts', emoji: '🎨' },
            'social': { name: 'Social & Relationships', emoji: '🤝' }
        };

        // Quick Tasks Database based on FINCH research
        const quickTasksDatabase = {
            'self-care': {
                name: 'Self-Care & Wellness',
                emoji: '💆',
                tasks: [
                    { id: 'brush_teeth', title: 'Brush teeth', emoji: '🦷', points: 2 },
                    { id: 'wash_face', title: 'Wash my face', emoji: '🧴', points: 2 },
                    { id: 'drink_water', title: 'Drink a glass of water', emoji: '💧', points: 2 },
                    { id: 'take_vitamins', title: 'Take vitamins', emoji: '💊', points: 3 },
                    { id: 'skincare', title: 'Do skincare routine', emoji: '🧴', points: 4 },
                    { id: 'shower', title: 'Take a shower', emoji: '🚿', points: 4 },
                    { id: 'moisturize', title: 'Moisturize skin', emoji: '🧴', points: 3 },
                    { id: 'floss', title: 'Floss teeth', emoji: '🦷', points: 3 }
                ]
            },
            'physical': {
                name: 'Physical Activity',
                emoji: '🏃',
                tasks: [
                    { id: 'pushups', title: 'Do 10 push-ups', emoji: '💪', points: 4 },
                    { id: 'squats', title: 'Do 15 squats', emoji: '🦵', points: 4 },
                    { id: 'plank', title: 'Hold plank for 30 seconds', emoji: '🏋️', points: 4 },
                    { id: 'walk', title: 'Take a 10-minute walk', emoji: '🚶', points: 5 },
                    { id: 'stretch', title: 'Stretch for 5 minutes', emoji: '🤸', points: 3 },
                    { id: 'yoga', title: 'Do yoga poses', emoji: '🧘', points: 5 },
                    { id: 'stairs', title: 'Take the stairs', emoji: '🪜', points: 3 },
                    { id: 'jumping_jacks', title: 'Do 20 jumping jacks', emoji: '🤸', points: 3 },
                    { id: 'dance', title: 'Dance to favorite song', emoji: '💃', points: 4 },
                    { id: 'bike_ride', title: 'Go for a bike ride', emoji: '🚴', points: 5 },
                    { id: 'run', title: 'Go for a run', emoji: '🏃', points: 5 },
                    { id: 'workout', title: 'Complete workout routine', emoji: '🏋️', points: 5 }
                ]
            },
            'sleep': {
                name: 'Sleep & Rest',
                emoji: '😴',
                tasks: [
                    { id: 'screen_warmth', title: 'Turn on screen warmth', emoji: '📱', points: 2 },
                    { id: 'no_caffeine', title: 'No caffeine after 2 PM', emoji: '☕', points: 3 },
                    { id: 'bedtime_routine', title: 'Start bedtime routine', emoji: '🛏️', points: 4 },
                    { id: 'read_book', title: 'Read before bed', emoji: '📚', points: 4 },
                    { id: 'meditation', title: 'Do 5-min meditation', emoji: '🧘', points: 4 },
                    { id: 'no_screens', title: 'No screens 1hr before bed', emoji: '📵', points: 4 },
                    { id: 'herbal_tea', title: 'Drink herbal tea', emoji: '🍵', points: 3 },
                    { id: 'dim_lights', title: 'Dim the lights', emoji: '💡', points: 2 },
                    { id: 'comfortable_clothes', title: 'Change to comfy clothes', emoji: '👕', points: 2 },
                    { id: 'breathing_exercise', title: 'Do breathing exercises', emoji: '🫁', points: 3 },
                    { id: 'journal', title: 'Write in journal', emoji: '📓', points: 4 },
                    { id: 'early_bedtime', title: 'Go to bed early', emoji: '🌙', points: 5 },
                    { id: 'power_nap', title: 'Take a 20-min power nap', emoji: '😴', points: 3 }
                ]
            },
            'tidy': {
                name: 'Tidy Up',
                emoji: '🧹',
                tasks: [
                    { id: 'laundry', title: 'Put laundry away', emoji: '👕', points: 4 },
                    { id: 'trash', title: 'Take out trash', emoji: '🗑️', points: 3 },
                    { id: 'dishes', title: 'Wash the dishes', emoji: '🍽️', points: 4 },
                    { id: 'make_bed', title: 'Make the bed', emoji: '🛏️', points: 3 },
                    { id: 'desk_clean', title: 'Clean desk/workspace', emoji: '🗂️', points: 4 },
                    { id: 'organize', title: 'Organize one drawer', emoji: '📦', points: 4 }
                ]
            },
            'mindfulness': {
                name: 'Mindfulness & Mental Health',
                emoji: '🧠',
                tasks: [
                    { id: 'deep_breaths', title: 'Take 5 deep breaths', emoji: '🫁', points: 2 },
                    { id: 'gratitude', title: 'Think of 3 things grateful for', emoji: '🙏', points: 3 },
                    { id: 'compliment_self', title: 'Give myself a compliment', emoji: '💝', points: 3 },
                    { id: 'mindful_moment', title: 'Have a mindful moment', emoji: '🧘', points: 4 },
                    { id: 'happiness', title: 'Do something that makes me happy', emoji: '😊', points: 5 }
                ]
            }
        };
        // ---- Daily Quick Tasks repopulation (7 tasks) ----
        function flattenQuickTasksDB() {
            const all = [];
            try {
                for (const catKey in quickTasksDatabase) {
                    const cat = quickTasksDatabase[catKey];
                    if (!cat || !Array.isArray(cat.tasks)) continue;
                    cat.tasks.forEach(t => {
                        all.push({ ...t, categoryName: cat.name, categoryEmoji: cat.emoji });
                    });
                }
            } catch (_) {}
            return all;
        }
        function pickRandomUnique(arr, n) {
            const out = [];
            const used = new Set();
            if (!Array.isArray(arr) || arr.length === 0) return out;
            while (out.length < n && used.size < arr.length) {
                const idx = Math.floor(Math.random() * arr.length);
                if (used.has(idx)) continue;
                used.add(idx);
                out.push(arr[idx]);
            }
            return out;
        }
        function repopulateQuickTasksIfNeeded(force=false) {
            try {
                const today = new Date().toDateString();
                const need = force || gameState.lastQuickTasksDate !== today || !Array.isArray(gameState.selectedQuickTasks) || gameState.selectedQuickTasks.length < 7;
                if (!need) return;
                const pool = flattenQuickTasksDB();
                const picked = pickRandomUnique(pool, 7);
                gameState.selectedQuickTasks = picked;
                gameState.lastQuickTasksDate = today;
                if (typeof saveGameState === 'function') saveGameState();
                if (typeof updateQuickTasksDisplay === 'function') updateQuickTasksDisplay();
            } catch (e) { /* no-op */ }
        }
        function scheduleQuickTasksMidnightRefresh() {
            const now = new Date();
            const nextMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0, 0).getTime();
            setTimeout(() => { repopulateQuickTasksIfNeeded(true); scheduleQuickTasksMidnightRefresh(); }, Math.max(0, nextMidnight - now.getTime()));
        }
        document.addEventListener('visibilitychange', () => { if (!document.hidden) repopulateQuickTasksIfNeeded(false); });
    

        // Shop Items
        const shopItems = {
            hats: [
                { id: 'blue_cap', name: 'Blue Cap', price: 50, image: 'assets/images/Frame 42.png' },
                { id: 'top_hat', name: 'Black Top Hat', price: 100, image: 'assets/images/Frame 43.png' },
                { id: 'army_helmet', name: 'Army Helmet', price: 200, image: 'assets/images/Frame 44.png' },
                { id: 'wizard_hat', name: 'Wizard Hat', price: 400, image: 'assets/images/Frame 45.png' }
            ],
            items: [
                { id: 'mustache', name: 'Mustache', price: 350, image: 'assets/images/mustache-thumbnail.png' },
                { id: 'glasses', name: 'Reading Glasses', price: 300, image: 'assets/images/Frame 46.png' }
            ],
            paints: [
                { id: 'buddy_paint', name: 'Buddy Paint', price: 800, image: 'assets/images/Group 55.png' },
                { id: 'rock_star', name: 'Rock Star', price: 1000, image: 'assets/images/Group 57.png' },
                { id: 'makeup', name: 'Makeup', price: 1100, image: 'assets/images/Frame 47.png' }
            ]
        };

        // Achievements
        const achievements = [
            { id: 'hot_streak', name: 'Hot Streak', desc: 'Complete tasks for 3 days in a row', icon: '🔥', requirement: 3, type: 'streak' },
            { id: 'week_warrior', name: 'Week Warrior', desc: 'Complete tasks for 7 days in a row', icon: '🔥', requirement: 7, type: 'streak' },
            { id: 'month_master', name: 'Month Master', desc: 'Complete tasks for 30 days in a row', icon: '🔥', requirement: 30, type: 'streak' },
            { id: 'getting_started', name: 'Getting Started', desc: 'Complete 10 tasks', icon: '🎯', requirement: 10, type: 'tasks' },
            { id: 'task_crusher', name: 'Task Crusher', desc: 'Complete 50 tasks', icon: '🎯', requirement: 50, type: 'tasks' },
            { id: 'century_club', name: 'Century Club', desc: 'Complete 100 tasks', icon: '🎯', requirement: 100, type: 'tasks' },
            { id: 'task_legend', name: 'Task Legend', desc: 'Complete 500 tasks', icon: '🎯', requirement: 500, type: 'tasks' },
            { id: 'rising_star', name: 'Rising Star', desc: 'Reach Level 5 with Jerry', icon: '⭐', requirement: 5, type: 'level' },
            { id: 'experienced_rock', name: 'Experienced Rock', desc: 'Reach Level 10 with Jerry', icon: '⭐', requirement: 10, type: 'level' },
            { id: 'ancient_wisdom', name: 'Ancient Wisdom', desc: 'Reach Level 20 with Jerry', icon: '⭐', requirement: 20, type: 'level' }
        ];

        // Rock speech messages
        const rockMessages = [
            "Hey there, Rock Star! Let's roll.",
            "Ready to crush some tasks today?",
            "You're doing great! Keep it up!",
            "Another goal to crush? Count me in!",
            "Let's make today productive!",
            "Time to rock and roll!",
            "You've got this, champion!",
            "Ready for another adventure?",
            "Let's turn those dreams into reality!",
            "Ooooh, we doing things today? I'm ready!"
        ];

        // Load game state from localStorage
        function loadGameState() {
            const saved = localStorage.getItem('taskRockGameState');
            if (saved) {
                const parsedState = JSON.parse(saved);
                gameState = { ...gameState, ...parsedState };
                
                // Ensure selectedQuickTasks exists
                if (!gameState.selectedQuickTasks) {
                    gameState.selectedQuickTasks = [];
                }
            }
        }

        // Save game state to localStorage
        function saveGameState() {
            localStorage.setItem('taskRockGameState', JSON.stringify(gameState));
        }

        // Update UI elements
        function updateUI() {
            // Update header info
            document.getElementById('creatureName').textContent = gameState.rockName;
            document.getElementById('healthFill').style.width = `${gameState.health}%`;
            document.getElementById('healthText').textContent = `Health: ${gameState.health} - Level ${gameState.level || 1}`;
            document.getElementById('taskPoints').textContent = `${gameState.taskPoints} Points`;
            
            // Update stats
            const totalTasks = gameState.tasks.length;
            const pendingTasks = gameState.tasks.filter(task => !task.completed).length;
            const completionRate = totalTasks > 0 ? Math.round((gameState.completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('totalTasksCount').textContent = totalTasks;
            document.getElementById('pendingTasksCount').textContent = pendingTasks;
            document.getElementById('completedTasksCount').textContent = gameState.completedTasks;
            document.getElementById('completionRateCount').textContent = `${completionRate}%`;
            // Today's tasks: tasks created today (local)
            const today = new Date(); today.setHours(0,0,0,0);
            const todaysTasks = gameState.tasks.filter(t => {
                const d = t && (t.createdAt || t.dueDate);
                if (!d) return false;
                const dt = new Date(d);
                if (isNaN(dt)) return false;
                const local = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
                return local.getTime() === today.getTime();
            }).length;
            const todaysEl = document.getElementById('todaysTasksCount');
            if (todaysEl) todaysEl.textContent = todaysTasks;

            document.getElementById('currentStreakCount').textContent = gameState.currentStreak;
            document.getElementById('jerryLevelCount').textContent = gameState.jerryLevel;
            document.getElementById('bestStreakCount').textContent = gameState.bestStreak;
            
            // Update expanded stats
            const experience = gameState.taskPoints || 0;
            const nextLevelXP = gameState.jerryLevel * 100;
            document.getElementById('experienceCount').textContent = `${experience}/${nextLevelXP} XP`;
            
            // Count unlocked achievements
            const unlockedAchievements = achievements.filter(achievement => {
                switch (achievement.type) {
                    case 'tasks':
                        return gameState.completedTasks >= achievement.requirement;
                    case 'streak':
                        return gameState.bestStreak >= achievement.requirement;
                    case 'level':
                        return gameState.jerryLevel >= achievement.requirement;
                    default:
                        return false;
                }
            }).length;
            document.getElementById('achievementsCount').textContent = `${unlockedAchievements}/${achievements.length}`;
            
            // Update tasks display
            updateTasksDisplay();
            updateQuickTasksDisplay();
            updateDailyChallengeDisplay();
            updateAchievementsDisplay();
            updateShopDisplay();
            updateSettingsDisplay();
            updateCreatureImage();
        }

        // Update creature image based on outfit
        function updateCreatureImage() {
            const creatureImage = document.getElementById('creatureImage');
            let imagePath = 'assets/images/jerry-base.png';
            
            // Apply paint first (base layer)
            if (gameState.currentOutfit.paint) {
                switch (gameState.currentOutfit.paint) {
                    case 'buddy_paint':
                        imagePath = 'assets/images/jerry-buddy.png';
                        break;
                    case 'rock_star':
                        imagePath = 'assets/images/jerry-rockstar.png';
                        break;
                    case 'makeup':
                        imagePath = 'assets/images/jerry-makeup.png';
                        break;
                }
            }
            
            creatureImage.src = imagePath;
        }

        // Expanded stats toggle
        let expandedStatsVisible = false;

        function toggleExpandedStats() {
            const expandedStats = document.getElementById('expandedStats');
            const showMoreText = document.getElementById('showMoreText');
            const showMoreArrow = document.getElementById('showMoreArrow');
            
            expandedStatsVisible = !expandedStatsVisible;
            
            if (expandedStatsVisible) {
                expandedStats.classList.add('show');
                showMoreText.textContent = 'Show Less';
                showMoreArrow.textContent = '▲';
            } else {
                expandedStats.classList.remove('show');
                showMoreText.textContent = 'Show More';
                showMoreArrow.textContent = '▼';
            }
        }

        // Tasks display
        function updateTasksDisplay() {
            const tasksList = document.getElementById('tasksList');
            if (!tasksList) return;
            
            if (gameState.tasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="quick-tasks-empty">
                        <div class="quick-tasks-empty-icon">📝</div>
                        <div class="quick-tasks-empty-text">No tasks yet</div>
                        <div class="quick-tasks-empty-subtext">Create your first task to get started</div>
                    </div>
                `;
                return;
            }
            
            tasksList.innerHTML = gameState.tasks.map((task, index) => {
                const category = categoryMap[task.category] || { name: 'General', emoji: '📝' };
                const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : null;
                
                return `
                    <div class="task-card">
                        <div class="task-header">
                            <div class="task-emoji">${category.emoji}</div>
                            <div class="task-content">
                                <div class="task-title">${task.title}</div>
                                <div class="task-category">${category.name}</div>
                            </div>
                            <div class="task-menu-container">
                                <button class="task-menu-btn" onclick="toggleTaskMenu(${index})">⋯</button>
                                <div id="taskMenu${index}" class="task-menu-dropdown">
                                    <button class="task-menu-item" onclick="editTask(${index}); closeTaskMenu(${index})">
                                        <span>✏️</span>
                                        <span>Edit</span>
                                    </button>
                                    <button class="task-menu-item delete" onclick="deleteTask(${index}); closeTaskMenu(${index})">
                                        <span>🗑️</span>
                                        <span>Delete</span>
                                    </button>
                                    ${task.recurring !== 'none' ? `
                                        <button class="task-menu-item" onclick="skipTask(${index}); closeTaskMenu(${index})">
                                            <span>⏭️</span>
                                            <span>Skip Today</span>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="task-meta">
                            <span class="task-badge difficulty-${task.difficulty}">${task.difficulty} (${task.points} pts)</span>
                            <span class="task-badge priority-${task.priority}">${task.priority} priority</span>
                            ${dueDate ? `<span class="task-badge">📅 ${dueDate}</span>` : ''}
                            ${task.recurring !== 'none' ? `<span class="task-badge">🔁 ${task.recurring}</span>` : ''}
                        </div>
                        <div class="task-actions">
                            <button class="complete-btn" onclick="completeTask(${index})">Complete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Task menu functions
        function toggleTaskMenu(index) {
            const menu = document.getElementById(`taskMenu${index}`);
            const isVisible = menu.classList.contains('show');
            
            // Close all other menus first
            document.querySelectorAll('.task-menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            // Toggle current menu
            if (!isVisible) {
                menu.classList.add('show');
            }
        }

        function closeTaskMenu(index) {
            const menu = document.getElementById(`taskMenu${index}`);
            menu.classList.remove('show');
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.task-menu-container')) {
                document.querySelectorAll('.task-menu-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });

        // Daily Challenges System
        
// Daily Challenges System (Quick Tasks only)
function generateDailyChallenge() {
    const quicks = Array.isArray(gameState.selectedQuickTasks) ? gameState.selectedQuickTasks : [];

    const freqByCat = {};
    quicks.forEach(q => {
        const cat = q.categoryName || 'General';
        freqByCat[cat] = (freqByCat[cat] || 0) + 1;
    });
    const topCat = Object.entries(freqByCat).sort((a,b) => b[1]-a[1])[0]?.[0];

    const candidates = [
        { id: 'qt_complete_3', name: 'Quick Blitz', desc: 'Complete 3 quick tasks today', target: 3, progress: 0, reward: 50 },
        { id: 'qt_morning', name: 'Early Spark', desc: 'Complete a quick task before 10 AM', target: 1, progress: 0, reward: 40 },
        { id: 'qt_evening', name: 'Night Owl', desc: 'Complete a quick task after 6 PM', target: 1, progress: 0, reward: 40 }
    ];

    if (topCat) {
        candidates.push({
            id: 'qt_cat_' + topCat.replace(/\s+/g, '_').toLowerCase(),
            name: 'Focus: ' + topCat,
            desc: 'Complete 2 ' + topCat + ' quick tasks',
            target: 2,
            progress: 0,
            reward: 45,
            meta: { categoryName: topCat }
        });
    }

    const today = new Date().toDateString();
    if (gameState.lastDailyChallengeDate !== today) {
        let chosen = candidates[Math.floor(Math.random() * candidates.length)];
        if (topCat && (freqByCat[topCat] || 0) >= 2) {
            const catOnly = candidates.filter(c => c.id.startsWith('qt_cat_'));
            if (catOnly.length) chosen = catOnly[0];
        }
        gameState.dailyChallenge = chosen;
        gameState.dailyChallengeCompleted = false;
        gameState.lastDailyChallengeDate = today;
    }
}



        function updateDailyChallengeDisplay() {
    const challengeDisplay = document.getElementById('dailyChallengeDisplay');
    if (!challengeDisplay) return;

    
if (!gameState.dailyChallenge) {
    const themeClass = 'theme-purple';
challengeDisplay.innerHTML = `
        <div class="daily-challenge-card ${themeClass}">
            <div class="challenge-title">📅 No Challenge Today</div>
            <div class="challenge-desc">Check back tomorrow for a new challenge!</div>
            <div class="challenge-progress-container">
                <div class="challenge-progress-label">Progress: 0/0</div>
                <div class="challenge-progress-bar">
                    <div class="challenge-progress-fill" style="width: 0%"></div>
                </div>
            </div>
            <div class="challenge-reward">🎁 Reward: 0 points</div>
        </div>
    `;
    return;
}


    
const themeClass = 'theme-purple';
const challenge = gameState.dailyChallenge;
const progressPercent = Math.min(100, (challenge.progress / challenge.target) * 100);
const isCompleted = gameState.dailyChallengeCompleted;

challengeDisplay.innerHTML = `
    <div class="daily-challenge-card ${themeClass} ${isCompleted ? 'challenge-completed' : ''}">
        <div class="challenge-title">📅 ${challenge.name}</div>
        <div class="challenge-desc">${challenge.desc}</div>
        <div class="challenge-progress-container">
            <div class="challenge-progress-label">Progress: ${challenge.progress}/${challenge.target}</div>
            <div class="challenge-progress-bar">
                <div class="challenge-progress-fill" style="width: ${gameState.dailyChallengeCompleted ? 100 : progressPercent}%" ></div>
            </div>
        </div>
        <div class="challenge-reward">🎁 Reward: ${challenge.reward} points</div>
    </div>
`;


    try { if (typeof applyDailyChallengeTheme === 'function') applyDailyChallengeTheme(); } catch(e) {}
}

// Only progress challenges when the source is Quick Tasks
let _dcSource = null; // 'quick' when a quick task triggers progress
let _lastQuickTaskCat = null;



        function updateDailyChallengeProgress() {
    if (!gameState.dailyChallenge || gameState.dailyChallengeCompleted) return false;
    if (_dcSource !== 'quick') return false;

    const challenge = gameState.dailyChallenge;
    let progressMade = false;
    const now = new Date();

    switch (challenge.id) {
        case 'qt_complete_3':
            challenge.progress = Math.min(challenge.target, challenge.progress + 1);
            progressMade = true;
            break;
        case 'qt_morning':
            if (now.getHours() < 10) {
                challenge.progress = Math.min(challenge.target, challenge.progress + 1);
                progressMade = true;
            }
            break;
        case 'qt_evening':
            if (now.getHours() >= 18) {
                challenge.progress = Math.min(challenge.target, challenge.progress + 1);
                progressMade = true;
            }
            break;
        default:
            if (challenge.id && challenge.id.indexOf('qt_cat_') === 0) {
                const targetCat = (challenge.meta && challenge.meta.categoryName) ? challenge.meta.categoryName : null;
                if (targetCat && _lastQuickTaskCat === targetCat) {
                    challenge.progress = Math.min(challenge.target, challenge.progress + 1);
                    progressMade = true;
                }
            }
            break;
    }

    if (challenge.progress >= challenge.target && !gameState.dailyChallengeCompleted) {
        gameState.dailyChallengeCompleted = true;
        gameState.taskPoints += challenge.reward;
        if (window.fireConfetti) { window.fireConfetti(); }
        showSuccessMessage(`📅 Daily Challenge Complete!\n${challenge.name}\n+${challenge.reward} bonus points!`);
        return true;
    }
    return progressMade;
}


        // Quick Tasks System
        function updateQuickTasksDisplay() {
            const quickTasksList = document.getElementById('quickTasksList');
            if (!quickTasksList) return;
            
            const activeTasks = gameState.selectedQuickTasks || [];
            
            if (activeTasks.length === 0) {
                quickTasksList.innerHTML = `
                    <div class="quick-tasks-empty">
                        <div class="quick-tasks-empty-icon">✨</div>
                        <div class="quick-tasks-empty-text">No quick tasks selected</div>
                        <div class="quick-tasks-empty-subtext">Add some quick tasks to boost your productivity</div>
                    </div>
                `;
            } else {
                quickTasksList.innerHTML = activeTasks.map(task => `
                    <div class="quick-task-item" onclick="completeQuickTask('${task.id}')">
                        <div class="quick-task-emoji">${task.emoji || '⚡'}</div>
                        <div class="quick-task-content">
                            <div class="quick-task-title">${task.title || 'Quick Task'}</div>
                            <div class="quick-task-category">${task.categoryName || 'General'}</div>
                        </div>
                        <div class="quick-task-points">+${task.points || 3} pts</div>
                        <div class="quick-task-actions">
        <button class="action-btn action-complete" onclick="event.stopPropagation(); completeQuickTask('${task.id}')" title="Complete" aria-label="Complete"><span class="icon-check">✓</span></button>
        <button class="action-btn action-remove" onclick="event.stopPropagation(); removeQuickTask('${task.id}')" title="Remove" aria-label="Remove"><span class="icon-x">×</span></button>
    </div>
                    </div>
                `).join('');
            }
        }

        // Achievements System
        function updateAchievementsDisplay() {
            const achievementsList = document.getElementById('achievementsList');
            if (!achievementsList) return;
            
            achievementsList.innerHTML = achievements.map(achievement => {
                let isUnlocked = false;
                let progress = 0;
                
                switch (achievement.type) {
                    case 'streak':
                        progress = gameState.bestStreak || 0;
                        isUnlocked = progress >= achievement.requirement;
                        break;
                    case 'tasks':
                        progress = gameState.completedTasks || 0;
                        isUnlocked = progress >= achievement.requirement;
                        break;
                    case 'level':
                        progress = gameState.jerryLevel || 1;
                        isUnlocked = progress >= achievement.requirement;
                        break;
                }
                
                return `
                    <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-content">
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-desc">${achievement.desc}</div>
                        </div>
                        <div class="achievement-status ${isUnlocked ? 'unlocked' : 'locked'}">
                            ${isUnlocked ? 'Unlocked' : 'Locked'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Shop System
        function updateShopDisplay() {
            updateShopSection('hatsShop', shopItems.hats);
            updateShopSection('itemsShop', shopItems.items);
            updateShopSection('paintShop', shopItems.paints);
        }

        function updateShopSection(containerId, items) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = items.map(item => {
                const canAfford = gameState.taskPoints >= item.price;
                const isOwned = gameState.ownedItems.includes(item.id);
                
                return `
                    <div class="shop-item ${canAfford ? 'affordable' : 'expensive'}" onclick="buyItem('${item.id}', ${item.price})">
                        <img src="${item.image}" alt="${item.name}" class="shop-item-image">
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-price">${isOwned ? 'Owned' : `${item.price} Points`}</div>
                    </div>
                `;
            }).join('');
        }

        function buyItem(itemId, price) {
            if (gameState.ownedItems.includes(itemId)) {
                showSuccessMessage('You already own this item!');
                return;
            }
            
            if (gameState.taskPoints < price) {
                showSuccessMessage('Not enough points!');
                return;
            }
            
            gameState.taskPoints -= price;
            gameState.ownedItems.push(itemId);
            
            // Auto-equip the item
            const item = [...shopItems.hats, ...shopItems.items, ...shopItems.paints].find(i => i.id === itemId);
            if (item) {
                if (shopItems.hats.includes(item)) {
                    gameState.currentOutfit.hat = itemId;
                } else if (shopItems.items.includes(item)) {
                    if (itemId === 'glasses') gameState.currentOutfit.glasses = itemId;
                    if (itemId === 'mustache') gameState.currentOutfit.mustache = itemId;
                } else if (shopItems.paints.includes(item)) {
                    gameState.currentOutfit.paint = itemId;
                }
            }
            
            saveGameState();
            updateUI();
            showSuccessMessage(`Purchased ${item.name}!`);
        }

        // Settings System
        function updateSettingsDisplay() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const notificationsToggle = document.getElementById('notificationsToggle');
            
            if (darkModeToggle) {
                darkModeToggle.classList.toggle('active', gameState.darkMode);
            }
            
            if (notificationsToggle) {
                notificationsToggle.classList.toggle('active', gameState.notifications);
            }
        }

        function toggleDarkMode() {
            gameState.darkMode = !gameState.darkMode;
            document.documentElement.setAttribute('data-theme', gameState.darkMode ? 'dark' : 'light');
            saveGameState();
            updateSettingsDisplay();
        }

        function toggleNotifications() {
            gameState.notifications = !gameState.notifications;
            saveGameState();
            updateSettingsDisplay();
            showSuccessMessage(`Notifications ${gameState.notifications ? 'enabled' : 'disabled'}!`);
        }

        function shareEtsyStore() {
            if (navigator.share) {
                navigator.share({
                    title: 'Task Rock - Rock Shop',
                    text: 'Check out these awesome accessories for Jerry!',
                    url: 'https://your-etsy-store-url.com'
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                const url = 'https://your-etsy-store-url.com';
                navigator.clipboard.writeText(url).then(() => {
                    showSuccessMessage('Store URL copied to clipboard!');
                });
            }
        }

        function showResetOptions() {
            if (confirm('Are you sure you want to reset your progress? This action cannot be undone.')) {
                if (confirm('This will delete ALL your tasks, points, and progress. Are you absolutely sure?')) {
                    localStorage.removeItem('taskRockGameState');
                    location.reload();
                }
            }
        }

        // Creature name editing
        function editCreatureName() {
            const nameElement = document.getElementById('creatureName');
            const inputElement = document.getElementById('creatureNameInput');
            
            nameElement.style.display = 'none';
            inputElement.style.display = 'block';
            inputElement.value = gameState.rockName;
            inputElement.focus();
            inputElement.select();
        }

        function saveCreatureName() {
            const nameElement = document.getElementById('creatureName');
            const inputElement = document.getElementById('creatureNameInput');
            
            const newName = inputElement.value.trim();
            if (newName && newName !== gameState.rockName) {
                gameState.rockName = newName;
                nameElement.textContent = newName;
                saveGameState();
                showSuccessMessage(`Rock renamed to ${newName}!`);
            }
            
            nameElement.style.display = 'block';
            inputElement.style.display = 'none';
        }

        function handleNameKeyPress(event) {
            if (event.key === 'Enter') {
                saveCreatureName();
            }
        }

        // Modal functions
        function openCreateTaskModal() {
            document.getElementById('createTaskModal').style.display = 'block';
            resetForm();
        }

        function closeModal() {
            document.getElementById('createTaskModal').style.display = 'none';
            resetForm();
        }

        function openQuickTaskModal() {
            document.getElementById('quickTaskModal').style.display = 'block';
            populateQuickTaskCategories();
        }

        function closeQuickTaskModal() {
            document.getElementById('quickTaskModal').style.display = 'none';
        }

        function populateQuickTaskCategories() {
            const container = document.getElementById('quickTaskCategories');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.keys(quickTasksDatabase).forEach(categoryKey => {
                const category = quickTasksDatabase[categoryKey];
                
                const categorySection = document.createElement('div');
                categorySection.className = 'category-section';
                categorySection.innerHTML = `
                    <div class="category-header">
                        <div class="category-emoji">${category.emoji}</div>
                        <div class="category-name">${category.name}</div>
                    </div>
                    <div class="category-tasks">
                        ${category.tasks.map(task => `
                            <div class="category-task-item" onclick="addQuickTask('${task.id}', '${categoryKey}')">
                                <div class="quick-task-emoji">${task.emoji}</div>
                                <div class="quick-task-content">
                                    <div class="quick-task-title">${task.title}</div>
                                    <div class="quick-task-category">${category.name}</div>
                                </div>
                                <div class="quick-task-points">+${task.points} pts</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(categorySection);
            });
        }

        // Task management functions
        function selectCategory(category) {
            // Remove previous selection
            document.querySelectorAll('[data-category]').forEach(el => el.classList.remove('selected'));
            // Add selection to clicked item
            document.querySelector(`[data-category="${category}"]`).classList.add('selected');
            selectedCategory = category;
        }

        function selectDifficulty(difficulty) {
            // Remove previous selection
            document.querySelectorAll('[data-difficulty]').forEach(el => el.classList.remove('selected'));
            // Add selection to clicked item
            document.querySelector(`[data-difficulty="${difficulty}"]`).classList.add('selected');
            selectedDifficulty = difficulty;
        }

        function selectPriority(priority) {
            // Remove previous selection
            document.querySelectorAll('[data-priority]').forEach(el => el.classList.remove('selected'));
            // Add selection to clicked item
            document.querySelector(`[data-priority="${priority}"]`).classList.add('selected');
            selectedPriority = priority;
        }

        function selectRecurring(recurring) {
            // Remove previous selection
            document.querySelectorAll('[data-recurring]').forEach(el => el.classList.remove('selected'));
            // Add selection to clicked item
            document.querySelector(`[data-recurring="${recurring}"]`).classList.add('selected');
            selectedRecurring = recurring;
        }

        function resetForm() {
            document.getElementById('taskForm').reset();
            document.querySelectorAll('.selection-item').forEach(el => el.classList.remove('selected'));
            selectedCategory = null;
            selectedDifficulty = null;
            selectedPriority = null;
            selectedRecurring = 'none';
            editingTaskIndex = null;
            document.querySelector('.modal-title').textContent = 'Create Task';
            document.querySelector('.btn-primary').textContent = 'Create Task';
            // Select default recurring option
            selectRecurring('none');
        }

        function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const dueDate = document.getElementById('taskDueDate').value;
            
            if (!title) {
                alert('Please enter a task title');
                return;
            }
            
            if (!selectedCategory) {
                alert('Please select a category');
                return;
            }
            
            if (!selectedDifficulty) {
                alert('Please select a difficulty');
                return;
            }
            
            if (!selectedPriority) {
                alert('Please select a priority');
                return;
            }
            
            const pointsMap = { easy: 2, medium: 5, hard: 10 };
            
            const task = {
                title,
                description,
                category: selectedCategory,
                difficulty: selectedDifficulty,
                priority: selectedPriority,
                points: pointsMap[selectedDifficulty],
                dueDate: dueDate || null,
                createdAt: new Date().toISOString(),
                completed: false,
                recurring: selectedRecurring || 'none',
                lastCompleted: null,
                streak: 0,
                totalCompletions: 0
            };
            
            if (editingTaskIndex !== null) {
                // Update existing task
                gameState.tasks[editingTaskIndex] = task;
                try { scheduleTaskNotifications(task); } catch(_) {}
                showSuccessMessage('Task updated successfully!');
            } else {
                // Add new task
                gameState.tasks.push(task);
                gameState.totalTasks = gameState.tasks.length;
                try { scheduleTaskNotifications(task); } catch(_) {}
                showSuccessMessage('Task created successfully!');
            }
            
            saveGameState();
            updateUI();
            closeModal();
        }

        function editTask(index) {
            const task = gameState.tasks[index];
            if (!task) return;
            
            editingTaskIndex = index;
            
            // Populate form
            document.getElementById('taskTitle').value = task.title || '';
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskDueDate').value = task.dueDate || '';
            
            // Select category, difficulty, priority, recurring
            if (task.category) selectCategory(task.category);
            if (task.difficulty) selectDifficulty(task.difficulty);
            if (task.priority) selectPriority(task.priority);
            if (task.recurring) selectRecurring(task.recurring);
            
            document.querySelector('.modal-title').textContent = 'Edit Task';
            document.querySelector('.btn-primary').textContent = 'Update Task';
            document.getElementById('createTaskModal').style.display = 'block';
        }

        function deleteTask(index) {
            if (confirm('Are you sure you want to delete this task?')) {
                gameState.tasks.splice(index, 1);
                gameState.totalTasks = gameState.tasks.length;
                saveGameState();
                updateUI();
                showSuccessMessage('Task deleted successfully!');
            }
        }

        function completeTask(index) {
            const task = gameState.tasks[index];
            if (!task) return;
            
            // Award points
            gameState.taskPoints += task.points || 5;
            gameState.completedTasks += 1;
            
            // Update Jerry's XP
            gameState.jerryXP += task.points || 5;
            
            // Check for level up
            while (gameState.jerryXP >= gameState.jerryXPToNext) {
                gameState.jerryXP -= gameState.jerryXPToNext;
                gameState.jerryLevel += 1;
                gameState.jerryXPToNext = Math.floor(gameState.jerryXPToNext * 1.2);
                
                // Fire confetti for level up
                if (window.fireConfetti) {
                    window.fireConfetti();
                }
                
                showSuccessMessage(`🎉 Jerry leveled up! Now Level ${gameState.jerryLevel}!`);
            }
            
            // Update streak
            const today = new Date().toDateString();
            if (gameState.lastCompletionDate === today) {
                // Already completed a task today, don't update streak
            } else {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (gameState.lastCompletionDate === yesterday.toDateString()) {
                    // Continuing streak
                    gameState.currentStreak += 1;
                } else {
                    // Starting new streak
                    gameState.currentStreak = 1;
                }
                
                if (gameState.currentStreak > gameState.bestStreak) {
                    gameState.bestStreak = gameState.currentStreak;
                }
                
                gameState.lastCompletionDate = today;
            }
            
            // Update daily challenge progress
            if (task.difficulty === 'hard') {
                _lastQuickTaskCat = (task && task.categoryName) ? task.categoryName : 'General';
        updateDailyChallengeProgress();
            }
            
            // Remove task
            gameState.tasks.splice(index, 1);
            gameState.totalTasks = gameState.tasks.length;
            
            saveGameState();
            updateUI();
            
            // Fire confetti animation
            if (window.fireConfetti) {
                window.fireConfetti();
            }
            
            showSuccessMessage(`Task completed! +${task.points || 5} points!`);
        }

        function addQuickTask(taskId, categoryKey) {
            const category = quickTasksDatabase[categoryKey];
            const task = category.tasks.find(t => t.id === taskId);
            
            if (!task) return;
            
            // Check if task already exists
            const exists = gameState.selectedQuickTasks.some(t => t.id === taskId);
            if (exists) {
                showSuccessMessage('Task already added!');
                return;
            }
            
            // Add task with category info
            const quickTask = {
                ...task,
                categoryName: category.name,
                categoryEmoji: category.emoji
            };
            
            gameState.selectedQuickTasks.push(quickTask);
            saveGameState();
            updateUI();
            closeQuickTaskModal();
            showSuccessMessage(`Added "${task.title}" to quick tasks!`);
        }

        function completeQuickTask(taskId) {
    // Mark DC progress as from Quick Tasks
    _dcSource = 'quick';

            const taskIndex = gameState.selectedQuickTasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const task = gameState.selectedQuickTasks[taskIndex];
            
            // Award points
            gameState.taskPoints += task.points || 3;
            gameState.completedTasks += 1;
            
            // Update Jerry's XP
            gameState.jerryXP += task.points || 3;
            
            // Check for level up
            while (gameState.jerryXP >= gameState.jerryXPToNext) {
                gameState.jerryXP -= gameState.jerryXPToNext;
                gameState.jerryLevel += 1;
                gameState.jerryXPToNext = Math.floor(gameState.jerryXPToNext * 1.2);
                
                // Fire confetti for level up
                if (window.fireConfetti) {
                    window.fireConfetti();
                }
                
                showSuccessMessage(`🎉 Jerry leveled up! Now Level ${gameState.jerryLevel}!`);
            }
            
            // Update daily challenge progress
            _lastQuickTaskCat = (task && task.categoryName) ? task.categoryName : 'General';
        updateDailyChallengeProgress();
            
            // Remove task
            gameState.selectedQuickTasks.splice(taskIndex, 1);
            
            saveGameState();
            updateUI();
            
            // Fire confetti animation
            if (window.fireConfetti) {
                window.fireConfetti();
            }
            
            showSuccessMessage(`Quick task completed! +${task.points || 3} points!`);
        
    _dcSource = null; _lastQuickTaskCat = null;
}

        function removeQuickTask(taskId) {
            const taskIndex = gameState.selectedQuickTasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                gameState.selectedQuickTasks.splice(taskIndex, 1);
                saveGameState();
                updateUI();
                showSuccessMessage('Quick task removed!');
            }
        }

        // Section toggle
        function toggleSection(sectionName) {
            const section = document.getElementById(`${sectionName}Section`);
            const arrow = document.getElementById(`${sectionName}Arrow`);
            
            if (section.classList.contains('expanded')) {
                section.classList.remove('expanded');
                arrow.textContent = '▼'; // DOWN arrow when collapsed
            } else {
                section.classList.add('expanded');
                arrow.textContent = '▲'; // UP arrow when expanded
            }
        }

        // Success message
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const createModal = document.getElementById('createTaskModal');
            const quickModal = document.getElementById('quickTaskModal');
            
            if (event.target === createModal) {
                closeModal();
            }
            if (event.target === quickModal) {
                closeQuickTaskModal();
            }
        });

        // Initialize section arrows
        function initializeSectionArrows() {
            const sections = [
                { id: 'tasks', expanded: true },
                { id: 'dailyChallenge', expanded: true },
                { id: 'quickTasks', expanded: true },
                { id: 'achievements', expanded: false },
                { id: 'shop', expanded: false },
                { id: 'settings', expanded: false }
            ];
            
            sections.forEach(section => {
                const arrow = document.getElementById(`${section.id}Arrow`);
                const sectionElement = document.getElementById(`${section.id}Section`);
                
                if (arrow && sectionElement) {
                    if (section.expanded) {
                        sectionElement.classList.add('expanded');
                        arrow.textContent = '▲'; // UP arrow when expanded
                    } else {
                        sectionElement.classList.remove('expanded');
                        arrow.textContent = '▼'; // DOWN arrow when collapsed
                    }
                }
            });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadGameState();
            generateDailyChallenge();
            repopulateQuickTasksIfNeeded(false);
            try { scheduleQuickTasksMidnightRefresh(); } catch (_) {}
            // Initialize selectedQuickTasks if it doesn't exist
            if (!gameState.selectedQuickTasks) {
                gameState.selectedQuickTasks = [];
            }
            
            // Apply dark mode if enabled
            if (gameState.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            
            // Initialize section arrows
            initializeSectionArrows();
            
            // Initialize confetti system
            initializeConfetti();
            
            updateUI();
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 1000);
        });

        // Confetti Animation System
        function initializeConfetti() {
            const canvas = document.getElementById("confetti-canvas");
            const ctx = canvas.getContext("2d");
            let particles = [];
            let animationFrame;

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            window.addEventListener("resize", resize);
            resize();

            function createParticle(x, y) {
                return {
                    x,
                    y,
                    dx: Math.random() * 6 - 3,
                    dy: Math.random() * -5 - 2,
                    size: Math.random() * 6 + 4,
                    color: `hsl(${Math.random() * 360}, 80%, 60%)`,
                    life: 100
                };
            }

            function render() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach((p, i) => {
                    p.x += p.dx;
                    p.y += p.dy;
                    p.dy += 0.1; // gravity
                    p.life--;

                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.size, p.size);

                    if (p.life <= 0) particles.splice(i, 1);
                });
                if (particles.length > 0) {
                    animationFrame = requestAnimationFrame(render);
                } else {
                    cancelAnimationFrame(animationFrame);
                    animationFrame = null;
                }
            }

            // Expose global function
            window.fireConfetti = function(x = canvas.width/2, y = canvas.height/2) {
                for (let i = 0; i < 80; i++) {
                    particles.push(createParticle(x, y));
                }
                if (!animationFrame) render();
            };
        }
    

document.addEventListener('DOMContentLoaded', () => {
    try {
        const container = document.querySelector('#content') || document.body;
        const quick = document.getElementById('quickTasksSection');
        const tasks = document.getElementById('tasksSection');
        const daily = document.getElementById('dailyChallengeSection');
        if (container && quick && tasks && daily) {
            container.appendChild(quick);
            container.appendChild(tasks);
            container.appendChild(daily);
        }
    } catch (e) { /* no-op */ }
});


document.addEventListener('DOMContentLoaded', () => {
        try {
            const quick = document.getElementById('quickTasksSection');
            const tasks = document.getElementById('tasksSection');
            const daily = document.getElementById('dailyChallengeSection');
            if (!(quick && tasks && daily)) return;
            // Anchor = first .section in the document (keeps us in the correct container)
            const firstSection = document.querySelector('.section');
            if (!firstSection) return;
            const parent = firstSection.parentElement;
            // Insert in reverse order before the first section so final order is Quick, Tasks, Daily
            parent.insertBefore(daily, firstSection);
            parent.insertBefore(tasks, firstSection);
            parent.insertBefore(quick, firstSection);
        } catch (_) {}
    });

// ----- Daily Challenge background cycle (scoped) -----
// 0: purple, 1: green, 2: orange
function getLocalMidnight(ts = Date.now()) {
  const d = new Date(ts); d.setHours(0,0,0,0); return d.getTime();
}
function getCycleStart() {
  let start = localStorage.getItem('dailyChallengeCycleStart');
  if (!start) { start = String(getLocalMidnight()); localStorage.setItem('dailyChallengeCycleStart', start); }
  return Number(start);
}
function getDailyThemeIndex() {
  const start = getCycleStart();
  const todayMidnight = getLocalMidnight();
  const daysSince = Math.floor((todayMidnight - start) / 86400000);
  return ((daysSince % 3) + 3) % 3;
}
function themeClassForIndex(i) { return ['theme-purple','theme-green','theme-orange'][i] || 'theme-purple'; }
function applyDailyChallengeTheme() {
  const card = document.querySelector('#dailyChallengeDisplay .daily-challenge-card');
  if (!card) return;
  card.classList.remove('theme-purple','theme-green','theme-orange');
  card.classList.add(themeClassForIndex(getDailyThemeIndex()));
}
function scheduleDailyThemeMidnightRefresh() {
  const now = new Date();
  const nextMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0, 0).getTime();
  setTimeout(() => { applyDailyChallengeTheme(); scheduleDailyThemeMidnightRefresh(); }, Math.max(0, nextMidnight - now.getTime()));
}
document.addEventListener('visibilitychange', () => { if (!document.hidden) applyDailyChallengeTheme(); });
window.addEventListener('load', () => scheduleDailyThemeMidnightRefresh());


/* ---------- Web Push Setup (iOS & Android PWAs) ---------- */
const PUSH_SERVER_BASE = '/api';
async function registerServiceWorker() {
  if (!('serviceWorker' in navigator)) return null;
  try {
    const reg = await navigator.serviceWorker.register('/sw.js');
    return reg;
  } catch (e) {
    console.warn('SW register failed', e);
    return null;
  }
}
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}
async function getVapidKey() {
  const r = await fetch(PUSH_SERVER_BASE + '/vapidPublicKey');
  if (!r.ok) throw new Error('Failed to fetch VAPID key');
  const { key } = await r.json();
  return key;
}
async function ensurePushSubscription() {
  if (!('Notification' in window) || Notification.permission === 'denied') return null;
  const reg = await registerServiceWorker();
  if (!reg) return null;
  let sub = await reg.pushManager.getSubscription();
  if (!sub) {
    const vapidKey = await getVapidKey();
    sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(vapidKey)
    });
  }
  try {
    await fetch(PUSH_SERVER_BASE + '/subscribe', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ subscription: sub, client: 'task-rock' })
    });
  } catch (_) {}
  return sub;
}
async function disablePushSubscription() {
  try {
    const reg = await navigator.serviceWorker.getRegistration();
    if (reg) {
      const sub = await reg.pushManager.getSubscription();
      if (sub) {
        await fetch(PUSH_SERVER_BASE + '/unsubscribe', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ endpoint: sub.endpoint })
        });
        await sub.unsubscribe();
      }
    }
  } catch (_) {}
}
async function scheduleTaskNotifications(task) {
  if (!task || !task.dueDate) return;
  try {
    const reg = await navigator.serviceWorker.getRegistration();
    const sub = reg ? await reg.pushManager.getSubscription() : null;
    if (!sub && gameState.notifications) await ensurePushSubscription();
    await fetch(PUSH_SERVER_BASE + '/schedule', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        title: task.title || 'Task due',
        taskId: task.id || task.title,
        dueDate: task.dueDate,
        offsets: [20,15,10,5,2],
        subscription: (await (await navigator.serviceWorker.getRegistration())?.pushManager.getSubscription()) || null
      })
    });
  } catch (e) { console.warn('scheduleTaskNotifications failed', e); }
}
const _origToggleNotifications = typeof toggleNotifications === 'function' ? toggleNotifications : null;
window.toggleNotifications = async function() {
  if (_origToggleNotifications) _origToggleNotifications();
  if (gameState && gameState.notifications) {
    await ensurePushSubscription();
  } else {
    await disablePushSubscription();
  }
};
window.addEventListener('load', async () => {
  try { if (gameState && gameState.notifications) await ensurePushSubscription(); } catch(_) {}
});



// --- Jerry Dialogue System (ported) ---


function showJerryDialog(message) {
            // Remove any existing dialogue bubbles
            const existingBubbles = document.querySelectorAll('.jerry-dialogue-bubble');
            existingBubbles.forEach(bubble => bubble.remove());

            const dialogueBox = document.createElement("div");
            dialogueBox.textContent = message;
            dialogueBox.className = "jerry-dialogue-bubble";
            
            // Make sure the container has relative positioning
            const container = document.querySelector('.creature-container');
            if (container) {
                container.style.position = 'relative';
                container.appendChild(dialogueBox);
                
                // Remove after 10 seconds
                setTimeout(() => {
                    if (dialogueBox.parentNode) {
                        dialogueBox.remove();
                    }
                }, 10000);
            }
        }

function getRandomMessage(category, subkey = null) {
            const source = jerryDialogues[category];
            if (!source) return "💬";
            
            let messages;
            const userName = gameState.userName;
            
            if (subkey) {
                // Handle subcategories (like health.high, health.mid, etc.)
                if (userName && source[`personalized${subkey.charAt(0).toUpperCase() + subkey.slice(1)}`]) {
                    // Use personalized version if user name exists
                    messages = source[`personalized${subkey.charAt(0).toUpperCase() + subkey.slice(1)}`];
                } else {
                    messages = source[subkey];
                }
            } else {
                // Handle main categories
                if (userName && jerryDialogues[`personalized${category.charAt(0).toUpperCase() + category.slice(1)}`]) {
                    // Use personalized version if user name exists
                    messages = jerryDialogues[`personalized${category.charAt(0).toUpperCase() + category.slice(1)}`];
                } else {
                    messages = Array.isArray(source) ? source : source.default || [];
                }
            }
            
            if (!messages || !Array.isArray(messages) || messages.length === 0) {
                return "💬";
            }
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            
            // Replace {name} placeholder with actual user name
            if (userName && randomMessage.includes('{name}')) {
                return randomMessage.replace(/{name}/g, userName);
            }
            
            return randomMessage;
        }

function initializeMotivationalPhrases() {
            // Show motivational phrase every 2 minutes (120000 ms)
            setInterval(() => {
                triggerJerryResponse('motivation');
            }, 120000);
        }

function getRandomMotivationalPhrase() {
            const userName = gameState.userName;
            const motivationalPhrases = userName ? jerryDialogues.personalizedMotivation : jerryDialogues.motivation;
            
            if (!motivationalPhrases || motivationalPhrases.length === 0) return "Keep going!";
            
            // Initialize last motivational phrase index if not exists
            if (!gameState.lastMotivationalPhraseIndex) {
                gameState.lastMotivationalPhraseIndex = -1;
            }
            
            let newIndex;
            // Ensure we don't repeat the same phrase back-to-back
            do {
                newIndex = Math.floor(Math.random() * motivationalPhrases.length);
            } while (newIndex === gameState.lastMotivationalPhraseIndex && motivationalPhrases.length > 1);
            
            gameState.lastMotivationalPhraseIndex = newIndex;
            saveGameState();
            
            const selectedPhrase = motivationalPhrases[newIndex];
            
            // Replace {name} placeholder with actual user name
            if (userName && selectedPhrase.includes('{name}')) {
                return selectedPhrase.replace(/{name}/g, userName);
            }
            
            return selectedPhrase;
        }

function initializeHealthMoodMonitoring() {
            // Check health mood thresholds every 30 seconds
            setInterval(() => {
                checkHealthMoodThresholds();
            }, 30000);
        }

function triggerJerryResponse(context, data = null) {
            let message = "";
            
            switch (context) {
                case 'greeting':
                    message = getRandomMessage("greetings");
                    break;
                    
                case 'health':
                    if (gameState.health >= 80) {
                        message = getRandomMessage("health", "high");
                    } else if (gameState.health >= 40) {
                        message = getRandomMessage("health", "mid");
                    } else {
                        message = getRandomMessage("health", "low");
                    }
                    break;
                    
                case 'healthMood':
                    message = getHealthMoodMessage();
                    break;
                    
                case 'taskComplete':
                    message = getRandomMessage("taskCompletion");
                    break;
                    
                case 'taskCreate':
                    message = getRandomMessage("taskCreation");
                    break;
                    
                case 'levelUp':
                    message = getRandomMessage("levelUp");
                    break;
                    
                case 'hydration':
                    message = getRandomMessage("hydrationReminders");
                    break;
                    
                case 'motivation':
                    message = getRandomMotivationalPhrase();
                    break;
                    
                default:
                    return; // Don't show anything for unknown contexts
            }
            
            if (message) {
                showJerryDialog(message);
            }
        }

function initializeJerryDialogue() {
            // Show greeting when app loads
            setTimeout(() => {
                triggerJerryResponse('greeting');
            }, 1000);

            // Initialize motivational phrase system
            initializeMotivationalPhrases();

            // Initialize health mood monitoring system
            initializeHealthMoodMonitoring();

            // Set up idle messages (every 2-3 minutes of inactivity)
            let idleTimer;
            function resetIdleTimer() {
                clearTimeout(idleTimer);
                idleTimer = setTimeout(() => {
                    triggerJerryResponse('idle');
                    resetIdleTimer(); // Set up next idle message
                }, Math.random() * 60000 + 120000); // 2-3 minutes
            }

            // Reset idle timer on user interaction
            ['click', 'scroll', 'keypress', 'touchstart'].forEach(event => {
                document.addEventListener(event, resetIdleTimer);
            });

            resetIdleTimer();

            // Health-based messages
            setInterval(() => {
                if (gameState.health < 60 && Math.random() < 0.3) {
                    triggerJerryResponse('health');
                }
            }, 300000); // Check every 5 minutes
        }

</script>
</body>
</html>



